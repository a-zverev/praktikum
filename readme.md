Работа с ампликонными библиотеками 16s rDNA на примере QIIME.

## Основной пайплайн

![image info](pictures/1-s2.0-S2001037019303745-gr2_lrg.jpg)

Основной пайплайн состоит из схожего количества шагов:

* Проверка данных
* Фильтрация по качеству
* Объединение парных ридов
* Фильтрация химер
* ОТU- или ASV-пикинг
* Таксономическая аннотация
* Нормализация
* Экологические индексы

Есть ли преимущества у ASV? И да, и нет. ESV pro: better taxa, ESV is consistent, ESV contra: too much diversity, difference in operons, quality sense

## Работа на удаленном сервере
Управление сервером по протоколу ssh. Мы можем получить доступ как к удаленному терминалу, так и к файловой системе удаленного сервера.
Для работы с удаленным сервером нужно знать несколько параметров:

* адрес сервера: 178.236.129.66
* порт для подключения: 9911
* логин и пароль: 

#### Linux

* Подключение к удаленному терминалу:

    `ssh perstuds@178.236.129.66 -p 9911`

После подключения имя пользователя и имя вашего локального компьютера, указанное у вас в терминале, изменится на имя аккаунта на сервере. В нашем случае это `perstuds@arriam-lab2-cpu`

* Копирование директории с сервера на локальную машину: 

    `scp -P 9911 -r perstuds@178.236.129.66:/home/perstuds/your_name/taxa_summary ~`

Обратите внимание, что команды копирования и присоединения по SSH выполняются на локальной машине, не на сервере)

#### Windows
Для удаленной работы нужно скачать и установить ssh-клиент. Например, Bitwise SSH Client - его можно скачать [здесь](https://www.bitvise.com/ssh-client-download). В соответствующих полях заполните адрес сервера, порт, имя пользователя и пароль. После подключения вам должен быть доступен удаленный терминал и окно обмена файлами.

### Правила безопасности

Поскольку мы все работаем от имени одного пользователя, у нас единое рабочее пространство. Чтобы не мешать друг другу, обязательное требование - каждый должен создать свою папку и работать только в ней.

* Создаем папку и переходим в нее: 

    mkdir your_name
    cd your_name

* Ваша рабочая директория (вывод команды pwd) должна выглядеть как `/home/perstuds/your_name/`

### Менеджер сессий tmux
Чтобы не потерять данные после закрытия терминала, создайте свою сессию в менеджере сессий. Задачи, запущенные в tmux, остаются активными после обрыва соединения.

* Создать именованную сессию: `tmux new -s your_name`
* Посмотреть список сессий: `tmux ls`
* Подключиться к текущей сессии `tmux att -t your_name`


## Утилиты и исходные данные

Исходные данные, как они выглядят, мы можем посмотреть в `/home/perstuds/raw`. Они хранятся в сжатом виде, и, чаще всего, уже разобраны по библиотекам. Исходные данные часто не очень хорошего качества, и прежде чем работать с ними, нужно сделать следующее:

* Оценить исходные данные: сколько получилось ридов, и каково их качество. FastQC
* Сделать тримммнг: обрезать неточно прочитанные последовательности. Trimmomatic
* Объединить парные прочтения, если они у нас есть. fastq-join
* Найти и удалить химерные прочтения. vsearch

Мы не будем останавливаться на этой части - готовые данные после этих операций находятся в `source/dechimered`

Также нам потребуется файл-карта с метаданными - описаниями наших последовательностей: `source/map.txt`

Скопируем их к себе:

    /home/perstuds/your_name/
    cp -r ../source/dechimered .
    cp ../source/map.txt .


## ОТЕ-пикинг

Все последующие шаги мы будем делать при помощи скриптов пакета [QIIME](http://qiime.org/). Этот пакет установлен в отдельном окружении, так что поменяйте окружение на `qiime1`

    conda activate qiime1

Для того, чтобы перейти непосредственно к ОТЕ-пикингу, необходимо создать единый fasta-файл для всех образцов. Для того, чтобы впоследствии знать, какая последовательность принадлежит какому из образцов, нужно добавить в заголовки последовательностей информацию, из какой пробы они взяты. Делается это при помощи скрипта [add_qiime_labels.py](http://qiime.org/scripts/add_qiime_labels.html):

    add_qiime_labels.py -i dechimered -m map.txt -c Filename -o combined_fasta

Теперь, если вы посмотрите заголовки последовательностей в `/combined_fasta/combined_seqs.fna`, вы убедитесь, что эта информация там есть.

Непосредственно ОТЕ-пикинг мы будем делать по методу closed-reference, поскольку в нашем распоряжении есть хорошая база данных по изучаемой последовательности. Воспользуемся скриптом [pick_closed_reference_otus.py](http://qiime.org/scripts/pick_closed_reference_otus.html):

    pick_closed_reference_otus.py -i combined_fasta/combined_seqs.fna -r /home/perstuds/tax_n_refs/silva_132_97_16S.fna -o otus -t /home/perstuds/tax_n_refs/taxonomy_7_levels.txt

По завершении ОТЕ-пикинга давайте выведем немного статистики по нашим образцам, и конвертируем в текстовый вид (информация о пакете [biom-format](http://biom-format.org/index.html)):

    biom summarize-table -i otus/otu_table.biom
    biom convert -i otus/otu_table.biom -o otus/otu_table.txt --to-tsv --header-key taxonomy
    

## Фильтры.

QIIME предоставляет большой набор инструментов для анализа и корректировки нашей выборки. Вот лишь несколько из вариантов:

* удалить образцы, общее число прочтений в которых ниже порога
* удалить ОТЕ, принадлежащие к определенному таксону
* удалить ОТЕ,встречающиеся слишком редко
* объединить повторности
* нормировать выборку

Полный список скриптов с кратким описанием доступен в разделе [Scripts](http://qiime.org/scripts/) Воспользуемся некоторыми из них. В частности, мы явно хотим исключить из анализа прочтения, принадлежащие последовательностям митохондрий и хлоропластов (скрипт [filter_taxa_from_otu_table.py](http://qiime.org/scripts/filter_taxa_from_otu_table.html)):

    filter_taxa_from_otu_table.py -i otus/otu_table.biom -o otus/f_otu_table.biom -n D_3__Chloroplast,D_4__Mitochondria

А также сортировать образцы по именам ([sort_otu_table.py](http://qiime.org/scripts/sort_otu_table.html)):

    sort_otu_table.py -i otus/f_otu_table.biom -o otus/sf_otu_table.biom

После этого давайте посмотрим барграфы представленности наших таксонов. Это удобная форма представления данных, позволяет получить представление о структуре сообщества (скрипт [summarize_taxa_through_plots.py](http://qiime.org/scripts/summarize_taxa_through_plots.html))

    summarize_taxa_through_plots.py -o taxa_summary -i otus/sf_otu_table.biom

В директории `/taxa_summary` теперь есть барграфы и барплоты. Посмотрев на них, можно принять решение, стоит ли убрать некоторые образцы-выбросы, хорошо ли повторности повторяют друг друга, и какие таксоны являются превалирующими.


## Нормировка

Следующий шаг, который нужно сделать, это нормировка. Стоит ли использовать нормировку вообще, и если да, то какую именно - вопрос дискуссионный, в статьях можно встретить самые разные варианты. В демонстрационных целях мы используем самый простой вариант нормировки, а именно разрежение (rarefaction). Нормировать мы будем на наименьшее число последовательностей среди образцов (скрипт [single_rarfaction.py](http://qiime.org/scripts/single_rarefaction.html).

    single_rarefaction.py -i otus/sf_otu_table.biom -o otus/nsf_otu_table.biom -d 10000

Также для некоторых анализов можно использовать информацию о таксономческой близости некоторых ОТЕ. Эта информация находится в файле дерева, которое есть в составе нашей базы референсов. Поскольку в наших образцах присутствуют не все ОТЕ, представленные в базе, необходимо обрезать дерево (скрипт [filter_tree.py](http://qiime.org/scripts/filter_tree.html)), удалив оттуда листья, которые не представлены в нашей таблице. Для этого нам понадобится список всех ОТЕ, включенных в таблицу. Проще всего получить его конвертированием таблицы в формат .txt и чтением первого столбца

```bash
    biom convert -i otus/nsf_otu_table.biom -o otus/nsf_otu_table.txt --to-tsv
    awk '(NR>3) {print$1}' otus/nsf_otu_table.txt > otus/otu_list.txt
    filter_tree.py -i /home/perstuds/tax_n_refs/97_otus.tre -t otus/otu_list.txt -o otus/filtered.tre
```

## Альфа- и бета-разнообразие

Теперь все готово для того, чтобы посчитать наконец индексы разнообразия. Используем скрипты [alpha_diversity.py](http://qiime.org/scripts/alpha_diversity.html) и [beta_diversity_through_plots.py](http://qiime.org/scripts/beta_diversity_through_plots.html). Помимо стандартных, вы можете использовать разные метрики.

    mkdir alpha_div
    alpha_diversity.py -i otus/nsf_otu_table.biom -m PD_whole_tree,chao1,observed_otus,shannon -o alpha_div/indexes.txt -t otus/filtered.tre
    beta_diversity_through_plots.py -i otus/nsf_otu_table.biom -o beta_div -t otus/filtered.tre -m map.txt


## Другие инструменты анализа 16s rDNA сообществ

ASV - Deblyr, DADA2, UNOISE2
OTU - QIIME, UPARSE Mothur


